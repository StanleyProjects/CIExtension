name: Pull request to unstable

on:
  pull_request:
    types: [opened, reopened]
    branches:
      - unstable

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - run: |
          echo "REPOSITORY_OWNER=${{github.event.repository.owner.login}}" >> "$GITHUB_ENV"
          echo "REPOSITORY_NAME=${{github.event.repository.name}}" >> "$GITHUB_ENV"
          mkdir -p workdir/prepare/repository
      - working-directory: workdir/prepare/repository
        env:
          GIT_BRANCH_SRC: ${{github.event.pull_request.head.sha}}
        run: |
          git init
          VCS_PAT="$(echo "${{secrets.VCS_TOKENS}}" | base64 -d | jq -Mcr .github.continuousi)"
          git remote add origin "https://${VCS_PAT}@github.com/${REPOSITORY_OWNER}/${REPOSITORY_NAME}.git"
          git fetch origin "$GIT_BRANCH_SRC"
          git checkout "$GIT_BRANCH_SRC"
      - working-directory: workdir/prepare
        env:
          VCS_DOMAIN: 'https://api.github.com'
          PR_NUMBER: ${{github.event.pull_request.number}}
        run: |
          mkdir ex; cp -r repository/ex/util ex/util
          export VCS_PAT="$(echo "${{secrets.VCS_TOKENS}}" | base64 -d | jq -Mcr .github.continuousi)"
          repository/.github/workflows/pr/merge.sh
      - working-directory: workdir
        run: |
          mv prepare/repository repository
          rm -rf prepare
          cp -r repository/ex ex
      - working-directory: workdir
        env:
          VCS_DOMAIN: 'https://api.github.com'
        run: |
          ex/github/assemble/repository.sh
          for it in $(cat repository/internal/env); do export $it; done
          ex/util/require VERSION
          ex/github/tag/test.sh "${VERSION}-UNSTABLE"
      - working-directory: workdir/repository
        run: |
          internal/check/readme.sh
          internal/unit/test/coverage.sh
          internal/unit/test.sh
      - working-directory: workdir/prepare/repository
        run: echo "Not implemented!"; exit 1 # todo
