name: Pull request to unstable

on:
  pull_request:
    types: [opened, reopened]
    branches:
      - unstable

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      VCS_DOMAIN: 'https://api.github.com'
      PR_NUMBER: ${{github.event.pull_request.number}}
    steps:
      - name: Set up repository
        env:
          REPOSITORY_OWNER: ${{github.event.repository.owner.login}}
          REPOSITORY_NAME: ${{github.event.repository.name}}
        run: |
          VCS_PAT="$(echo "${{secrets.VCS_TOKENS}}" | base64 -d | jq -Mcr .github.continuousi)"
          mkdir -p workdir/repository
          git -C workdir/repository init
          git -C workdir/repository \
           remote add origin "https://${VCS_PAT}@github.com/${REPOSITORY_OWNER}/${REPOSITORY_NAME}.git"
          git -C workdir/repository fetch origin "${{github.event.pull_request.head.ref}}"
          git -C workdir/repository checkout FETCH_HEAD
          mkdir workdir/ex
          cp -r workdir/repository/ex/util workdir/ex/
      - name: Pull request merge
        working-directory: workdir
        env:
          REPOSITORY_OWNER: ${{github.event.repository.owner.login}}
          REPOSITORY_NAME: ${{github.event.repository.name}}
        run: |
          export VCS_PAT
          . ex/util/json --base64 "${{secrets.VCS_TOKENS}}" -sfs .github.continuousi VCS_PAT
          repository/internal/shell/workflow/pull/request/prepare/merge.sh
          IMAGE_NAME="${REPOSITORY_OWNER}.${REPOSITORY_NAME}.pr.unstable"
          echo "IMAGE_NAME=${IMAGE_NAME,,}" >> $GITHUB_ENV
      - name: Build image
        working-directory: workdir
        env:
          REPOSITORY_OWNER: ${{github.event.repository.owner.login}}
          REPOSITORY_NAME: ${{github.event.repository.name}}
        run: |
          . ex/util/json --base64 "${{secrets.VCS_TOKENS}}" -sfs .github.continuousi VCS_PAT
          docker build --no-cache \
           --build-arg="VCS_PAT=$VCS_PAT" \
           --build-arg="REPOSITORY_OWNER=$REPOSITORY_OWNER" \
           --build-arg="REPOSITORY_NAME=$REPOSITORY_NAME" \
           --build-arg="GIT_BRANCH_SRC=${{github.event.pull_request.head.ref}}" \
           --build-arg="VCS_DOMAIN=$VCS_DOMAIN" \
           --build-arg="PR_NUMBER=$PR_NUMBER" \
           --build-arg="CI_BUILD_ID=$GITHUB_RUN_ID" \
           -f='repository/internal/docker/workflow/pull/request/Dockerfile' \
           -t="${IMAGE_NAME}:${GITHUB_RUN_ID}" .
      - name: Run container
        working-directory: workdir
        run: |
          . ex/util/json --base64 "${{secrets.VCS_TOKENS}}" \
           -sfs .github.continuousi VCS_PAT
          . ex/util/json --base64 "${{secrets.TELEGRAM}}" \
           -si .bot.continuousibot.id TELEGRAM_BOT_ID \
           -sfs .bot.continuousibot.token TELEGRAM_BOT_TOKEN \
           -si .chat.kepocnhh.id TELEGRAM_CHAT_ID
          docker run --rm \
           -e VCS_PAT="$VCS_PAT" \
           -e PR_NUMBER="$PR_NUMBER" \
           -e TELEGRAM_BOT_ID="$TELEGRAM_BOT_ID" \
           -e TELEGRAM_BOT_TOKEN="$TELEGRAM_BOT_TOKEN" \
           -e TELEGRAM_CHAT_ID="$TELEGRAM_CHAT_ID" \
           --name="container.${IMAGE_NAME}" "${IMAGE_NAME}:${GITHUB_RUN_ID}" \
           repository/internal/shell/workflow/pull/request/unstable.sh
      - name: Not implemented!
        run: echo "Not implemented!"; exit 1
      - working-directory: workdir
        run: |
          mv prepare/repository repository
          rm -rf prepare
          cp -r repository/ex ex
      - name: Set up pull request
        working-directory: workdir
        run: |
          ex/github/assemble/repository.sh
          ex/github/assemble/repository/owner.sh
          ex/github/assemble/pr.sh
          export VCS_PAT
          . ex/util/json --base64 "${{secrets.VCS_TOKENS}}" -sfs .github.continuousi VCS_PAT
          ex/github/assemble/worker.sh
          ex/github/assemble/pr/commit.sh
          export CI_BUILD_ID=$GITHUB_RUN_ID
          ex/github/assemble/actions/run.sh
      - name: Check version
        working-directory: workdir
        run: |
          . ex/util/export VCS_PAT TELEGRAM_BOT_ID TELEGRAM_BOT_TOKEN TELEGRAM_CHAT_ID
          . ex/util/json --base64 "${{secrets.VCS_TOKENS}}" -sfs .github.continuousi VCS_PAT
          for it in $(cat repository/internal/env); do export $it; done
          ex/util/require VERSION
          . ex/util/json --base64 "${{secrets.TELEGRAM}}" \
           -si .bot.continuousibot.id TELEGRAM_BOT_ID \
           -sfs .bot.continuousibot.token TELEGRAM_BOT_TOKEN \
           -si .chat.kepocnhh.id TELEGRAM_CHAT_ID
          ex/github/workflow/tag/test.sh "${VERSION}-UNSTABLE"
      - name: Artifacts
        working-directory: workdir
        run: |
          for it in $(cat repository/internal/env); do export $it; done
          ex/util/require VERSION
          mkdir -p assemble/project/artifact
          ARTIFACT="CIExtension-${VERSION}-UNSTABLE.zip"
          KEY_ALIAS='debug'
          $(ISSUER="$(pwd)" && cd "$ISSUER" && zip -r9 "assemble/project/artifact/$ARTIFACT" ci ex > /dev/null)
          . ex/util/json --base64 "${{secrets.KEYSTORES}}" \
           -sfs ".${KEY_ALIAS}.base64" KEYSTORE \
           -sfs ".${KEY_ALIAS}.password" KEYSTORE_PASSWORD
          echo "$KEYSTORE" | base64 -d > "assemble/project/${KEY_ALIAS}.pkcs12"
          ex/util/sign -i "assemble/project/artifact/$ARTIFACT" -s "assemble/project/artifact/${ARTIFACT}.sig" \
           -k "assemble/project/${KEY_ALIAS}.pkcs12" -p "$KEYSTORE_PASSWORD"
          . ex/util/json --base64 "${{secrets.FINGERPRINTS}}" -sfs ".key.${KEY_ALIAS}.x509.sha512" KEY_X509_SHA512
          ACTUAL_FINGERPRINT="$(openssl pkcs12 -legacy -in "assemble/project/${KEY_ALIAS}.pkcs12" \
            -nokeys -passin "pass:$KEYSTORE_PASSWORD" | openssl x509 -noout -fingerprint -sha512)"
          EXPECTED_FINGERPRINT="SHA512 Fingerprint=$KEY_X509_SHA512"
          . ex/util/assert -eqv "${ACTUAL_FINGERPRINT^^}" "${EXPECTED_FINGERPRINT^^}"
      - name: VCS push
        working-directory: workdir
        env:
          PR_NUMBER: ${{github.event.pull_request.number}}
        run: |
          ex/github/workflow/pr/commit.sh
          git -C repository push
          ex/github/assemble/commit.sh
      - name: GitHub release
        working-directory: workdir
        run: |
          for it in $(cat repository/internal/env); do export $it; done
          ex/util/require VERSION
          BODY='{}'
          TAG="${VERSION}-UNSTABLE"
          . ex/util/json -f assemble/vcs/commit.json -sfs .sha GIT_COMMIT_SHA
          . ex/util/json -f assemble/vcs/actions/run.json \
           -si .run_number CI_BUILD_NUMBER -sfs .html_url CI_BUILD_HTML_URL
          . ex/util/json_merge -v BODY \
           ".name=\"$TAG\"" ".tag_name=\"$TAG\"" \
           ".target_commitish=\"$GIT_COMMIT_SHA\"" \
           ".body=\"CI build [#$CI_BUILD_NUMBER]($CI_BUILD_HTML_URL)\"" \
           '.draft=false' '.prerelease=true'
          mkdir assemble/github
          export VCS_PAT
          . ex/util/json --base64 "${{secrets.VCS_TOKENS}}" -sfs .github.continuousi VCS_PAT
          ex/github/release.sh "$BODY"
          ASSET_NAME="CIExtension-${VERSION}-UNSTABLE.zip"
          ASSETS='[]'
          ASSET='{}'
          . ex/util/json_merge -v ASSET \
           ".name=\"$ASSET_NAME\"" ".label=\"$ASSET_NAME\"" \
           ".path=\"assemble/project/artifact/$ASSET_NAME\""
          . ex/util/json_merge -v ASSETS ".+=[$ASSET]"
          echo "Not implemented! sign"; exit 1 # todo
          ex/github/release/upload/asset.sh "$ASSETS"
      - name: On success
        working-directory: workdir
        env:
          PR_NUMBER: ${{github.event.pull_request.number}}
        run: |
          ex/github/workflow/pr/check_state.sh 'closed'
          for it in $(cat repository/internal/env); do export $it; done
          ex/util/require VERSION
          TAG="${VERSION}-UNSTABLE"
          . ex/util/json -f assemble/vcs/actions/run.json \
           -si .run_number CI_BUILD_NUMBER \
           -sfs .html_url CI_BUILD_HTML_URL
          . ex/util/json -f assemble/vcs/repository.json \
           -sfs .name REPOSITORY_NAME \
           -sfs .html_url REPOSITORY_HTML_URL
          MESSAGE="Merged by CI build [#$CI_BUILD_NUMBER]($CI_BUILD_HTML_URL) \
           - release [$TAG]($REPOSITORY_HTML_URL/releases/tag/$TAG)"
          ex/github/pr/comment.sh "$MESSAGE"
          echo "Not implemented! on_success"; exit 1 # todo
